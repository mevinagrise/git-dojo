#!/opt/pwn.college/bash

if ! command -v git >/dev/null 2>&1; then
  apt update && apt install -y git
fi

sudo -u hacker bash <<'EOF'

mkdir -p /tmp/repo

cd /tmp/repo

git init >/dev/null 2>&1

# 定义作者和邮箱
authors=("pwnuser" "alice" "bob")
emails=("pwn@hust.edu.cn" "alice@example.com" "bob@example.com")

# 常用提交前缀
prefixes=(
  "update"
  "fix"
  "refactor"
  "add"
  "remove"
  "improve"
  "clean"
  "change"
  "optimize"
  "rework"
)

# 常用后缀
suffixes=(
  ""
  "WIP"
  "quick fix"
  "final"
  "test"
)

# 初始 commit
echo "start" > file0.txt
GIT_AUTHOR_NAME="${authors[0]}" GIT_AUTHOR_EMAIL="${emails[0]}" \
GIT_COMMITTER_NAME="${authors[0]}" GIT_COMMITTER_EMAIL="${emails[0]}" \
git add file0.txt && git commit -m "initial commit" >/dev/null 2>&1

for i in $(seq 1 80); do
    echo "data $i" >> data.txt
    git add data.txt

    # 随机作者
    idx=$((RANDOM % ${#authors[@]}))

    # 随机日期：过去30天
    random_days=$((RANDOM % 30))
    commit_date="$(date -d "$random_days days ago" +"%Y-%m-%dT%H:%M:%S")"

    # 插入 magicword 正确答案
    if [ "$i" -eq 37 ]; then
        msg="fix containing magicword"

    # 干扰提交
    elif [ "$i" -eq 5 ]; then
        msg="fix something magic"
    elif [ "$i" -eq 12 ]; then
        msg="add mysterious word"
    elif [ "$i" -eq 22 ]; then
        msg="magic happens here"
    elif [ "$i" -eq 33 ]; then
        msg="another random magic change"
    elif [ "$i" -eq 44 ]; then
        msg="word related update"
    elif [ "$i" -eq 68 ]; then
        msg="temporary magic fix"

    else
        # 其他提交随机生成
        prefix=${prefixes[$((RANDOM % ${#prefixes[@]}))]}
        suffix=${suffixes[$((RANDOM % ${#suffixes[@]}))]}
        msg="$prefix file $i"
        [ -n "$suffix" ] && msg="$msg - $suffix"
    fi

    GIT_AUTHOR_DATE="$commit_date" GIT_COMMITTER_DATE="$commit_date" \
    GIT_AUTHOR_NAME="${authors[$idx]}" GIT_AUTHOR_EMAIL="${emails[$idx]}" \
    GIT_COMMITTER_NAME="${authors[$idx]}" GIT_COMMITTER_EMAIL="${emails[$idx]}" \
    git commit -m "$msg" >/dev/null 2>&1
    
done

# 查找
TARGET_COMMIT=$(git log --all --grep="magicword" --pretty=format:%H | head -n 1)
echo "$TARGET_COMMIT" > /tmp/tmp_expected_commit

EOF

# root 用户收集
mv /tmp/tmp_expected_commit /expected_commit
chown root:root /expected_commit
chmod 400 /expected_commit